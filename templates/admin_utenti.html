{% extends "layout_admin.html" %}

{% block admin_title %}Utenti Registrati{% endblock %}
{% block admin_subtitle %}Gestione degli utenti, dello stato degli account e delle azioni amministrative.{% endblock %}

{% block admin_content %}

<style>
/* FILTRI */
.filter-box {
    background: #fafafa;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 18px;
    margin-bottom: 22px;
}

.filter-box input,
.filter-box select {
    border-radius: 10px;
    border: 1px solid #d1d5db;
    padding: 8px 10px;
    background: white;
    width: 100%;
}

/* BADGE */
.badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-green { background: #dcfce7; color: #166534; }
.badge-red { background: #fee2e2; color: #991b1b; }
.badge-yellow { background: #fef9c3; color: #854d0e; }

/* TABELLA */
.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.table-wrapper table td,
.table-wrapper table th {
    padding: 12px;
    white-space: nowrap;
}
</style>

<!-- FILTRI -->
<form method="get" class="filter-box grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">

    <div>
        <label class="text-xs font-medium text-gray-600">Nome / Cognome</label>
        <input type="text" name="nome" value="{{ request.args.get('nome','') }}" placeholder="Cerca nome">
    </div>

    <div>
        <label class="text-xs font-medium text-gray-600">Email</label>
        <input type="text" name="email" value="{{ request.args.get('email','') }}" placeholder="Email">
    </div>

    <div class="relative">
      <label class="text-xs font-medium text-gray-600">CittÃ </label>
      <input
        type="text"
        id="citta-autocomplete"
        name="citta"
        value="{{ request.args.get('citta','') }}"
        placeholder="CittÃ "
      >

      <div id="citta-suggerimenti"
           class="absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow hidden max-h-60 overflow-auto">
      </div>
    </div>

    <div class="relative">
      <label class="text-xs font-medium text-gray-600">Provincia</label>
      <input
        type="text"
        id="provincia-autocomplete"
        name="provincia"
        value="{{ request.args.get('provincia','') }}"
        placeholder="Es. MI, PV, RM"
      >

      <div id="provincia-suggerimenti"
           class="absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow hidden max-h-60 overflow-auto">
      </div>
    </div>

    <div>
        <label class="text-xs font-medium text-gray-600">Stato account</label>
        <select name="stato">
            <option value="">Tutti</option>
            <option value="attivo"
              {% if request.args.get('stato')=='attivo' %}selected{% endif %}>Attivo</option>
            <option value="sospeso"
              {% if request.args.get('stato')=='sospeso' %}selected{% endif %}>Sospeso</option>
            <option value="non_attivo"
              {% if request.args.get('stato')=='non_attivo' %}selected{% endif %}>Non attivo</option>
        </select>
    </div>

    <div class="sm:col-span-2 lg:col-span-4 flex gap-2 mt-2">
        <button class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
            Filtra
        </button>
        <a href="{{ url_for('admin_utenti') }}"
           class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">
            Reset
        </a>
    </div>

</form>

<!-- TABELLA UTENTI -->
<div class="table-wrapper bg-white rounded-xl border border-gray-200 shadow-sm">

    <table class="w-full text-sm">
        <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Cognome</th>
                <th>Email</th>
                <th>Username</th>
                <th>CittÃ </th>
                <th>Provincia</th>
                <th>Stato</th>
                <th class="text-center">Azioni</th>
            </tr>
        </thead>

        <tbody class="divide-y divide-gray-100">
            {% for u in utenti %}
            <tr class="hover:bg-gray-50">

                <td>{{ u.id }}</td>

                <td>{{ u.nome }}</td>

                <td>{{ u.cognome }}</td>

                <td>{{ u.email }}</td>

                <td>{{ u.username }}</td>

                <td>{{ u.citta or "-" }}</td>

                <td>{{ u.provincia or "-" }}</td>

                <td>
                    {% if u.sospeso == 1 %}
                        <span class="badge badge-yellow">Sospeso</span>
                    {% elif u.attivo == 1 %}
                        <span class="badge badge-green">Attivo</span>
                    {% else %}
                        <span class="badge badge-red">Non attivo</span>
                    {% endif %}
                </td>

                <td class="text-center flex items-center justify-center gap-3">

                  <!-- ðŸ”„ ATTIVA / DISATTIVA ACCOUNT -->
                  <a href="{{ url_for('toggle_utente_admin', id=u.id) }}"
                     class="text-blue-600 hover:underline">
                    {{ 'Disattiva' if u.attivo else 'Attiva' }}
                  </a>

                  <!-- ðŸ—‘ï¸ ELIMINA -->
                  <a href="{{ url_for('elimina_utente_route', id=u.id) }}"
                     onclick="return confirm('Eliminare questo utente?');"
                     class="text-red-600 hover:underline">
                    Elimina
                  </a>

                  <!-- ðŸ“ž TOGGLE CONTATTI PROFILO -->
                  <button
                    type="button"
                    onclick="toggleContattiProfilo({{ u.id }})"
                    class="
                      px-3 py-1.5 rounded-full text-xs font-semibold border transition
                      {% if u.contatti_attivi %}
                        bg-blue-600 text-white border-blue-600 hover:bg-blue-700
                      {% else %}
                        bg-white text-gray-500 border-gray-300 hover:bg-gray-100
                      {% endif %}
                    ">
                    ðŸ“ž Contatti
                  </button>

                </td>
              </tr>
            {% endfor %}
        </tbody>
    </table>

</div>
<script>
  window.CSRF_TOKEN = "{{ session['csrf_token'] }}";
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const inputCitta = document.getElementById("citta-autocomplete");
  const listCitta  = document.getElementById("citta-suggerimenti");

  const inputProv  = document.getElementById("provincia-autocomplete");
  const listProv   = document.getElementById("provincia-suggerimenti");

  if (!inputCitta || !listCitta || !inputProv || !listProv) return;

  let comuni = [];
  let cittaSelected = false;
  let provSelected = false;

  const norm = s =>
    (s || "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/['â€™]/g, "")
      .trim();

  const score = (text, q) => {
    if (text === q) return 0;
    if (text.startsWith(q)) return 1;
    if (text.includes(q)) return 2;
    return 99;
  };

  // Carico comuni.json
  fetch("/static/data/comuni.json")
    .then(r => r.json())
    .then(d => { comuni = Array.isArray(d) ? d : []; })
    .catch(() => { comuni = []; });

  // ---------------------------
  // AUTOCOMPLETE CITTA
  // ---------------------------
  inputCitta.setAttribute("autocomplete", "off");

  inputCitta.addEventListener("input", () => {
    const qRaw = inputCitta.value.trim();
    const q = norm(qRaw);

    cittaSelected = false;
    listCitta.innerHTML = "";

    if (q.length < 2) {
      listCitta.classList.add("hidden");
      return;
    }

    const risultati = comuni
      .map(c => ({
        comune: c.comune,
        provincia: (c.provincia || "").toString().trim().toUpperCase(),
        _s: score(norm(c.comune), q)
      }))
      .filter(x => x._s < 99)
      .sort((a, b) => a._s - b._s || norm(a.comune).localeCompare(norm(b.comune)))
      .slice(0, 10);

    if (!risultati.length) {
      listCitta.classList.add("hidden");
      return;
    }

    risultati.forEach(x => {
      const el = document.createElement("div");
      el.textContent = `${x.comune} (${x.provincia})`;
      el.className = "px-4 py-2 cursor-pointer hover:bg-gray-100 text-sm";

      el.addEventListener("pointerdown", e => {
        e.preventDefault();
        inputCitta.value = x.comune;

        // opzionale ma comodo: quando scegli una cittÃ , compila anche la provincia
        if (x.provincia) inputProv.value = x.provincia;

        cittaSelected = true;
        listCitta.classList.add("hidden");
      });

      listCitta.appendChild(el);
    });

    listCitta.classList.remove("hidden");
  });

  inputCitta.addEventListener("blur", () => {
    setTimeout(() => {
      // qui NON svuotiamo: se uno scrive cittÃ  a mano deve poter filtrare lo stesso
      listCitta.classList.add("hidden");
    }, 120);
  });

  // ---------------------------
  // AUTOCOMPLETE PROVINCIA
  // ---------------------------
  const getProvince = () => {
    const set = new Set();
    comuni.forEach(c => {
      if (c && c.provincia) set.add(String(c.provincia).trim().toUpperCase());
    });
    return Array.from(set).sort((a, b) => a.localeCompare(b));
  };

  inputProv.setAttribute("autocomplete", "off");

  inputProv.addEventListener("input", () => {
    const qRaw = inputProv.value.trim().toUpperCase();
    const q = norm(qRaw);

    provSelected = false;
    listProv.innerHTML = "";

    if (q.length < 1) {
      listProv.classList.add("hidden");
      return;
    }

    const province = getProvince();

    const risultati = province
      .map(p => ({ p, _s: score(norm(p), q) }))
      .filter(x => x._s < 99)
      .sort((a, b) => a._s - b._s || a.p.localeCompare(b.p))
      .slice(0, 10);

    if (!risultati.length) {
      listProv.classList.add("hidden");
      return;
    }

    risultati.forEach(x => {
      const el = document.createElement("div");
      el.textContent = x.p;
      el.className = "px-4 py-2 cursor-pointer hover:bg-gray-100 text-sm";

      el.addEventListener("pointerdown", e => {
        e.preventDefault();
        inputProv.value = x.p;
        provSelected = true;
        listProv.classList.add("hidden");
      });

      listProv.appendChild(el);
    });

    listProv.classList.remove("hidden");
  });

  inputProv.addEventListener("blur", () => {
    setTimeout(() => {
      listProv.classList.add("hidden");
    }, 120);
  });
});
</script>
<script>
function toggleContattiProfilo(utenteId) {
  fetch("/admin/toggle-servizio", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
      "X-CSRF-Token": window.CSRF_TOKEN
    },
    body: JSON.stringify({
      codice_servizio: "contatti",
      utente_id: utenteId
    })
  })
  .then(r => r.json())
  .then(data => {
    if (!data.ok) {
      alert(data.error || "Errore");
      return;
    }
    location.reload();
  })
  .catch(() => alert("Errore di rete"));
}
</script>

{% endblock %}
