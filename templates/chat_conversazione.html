{% extends "base.html" %}

{% block head_extra %}
  <meta name="chat-aperta" content="true">
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.body.dataset.chat = "true";
    });
  </script>
{% endblock %}

{% block content %}
<style>
:root {
  --navbar-height: 70px;
}

/* ğŸŒ DESKTOP */
body {
  background: linear-gradient(to bottom right, #f9fafb, #eef2f7);
}

.max-w-3xl.mx-auto {
  border-radius: 1.25rem;
  overflow: hidden;
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(8px);
  border: 1px solid #e5e7eb;
  margin-top: 0 !important;
}

/* ğŸ’¬ Bolle messaggi */
.bubble {
  border-radius: 1rem;
  padding: 0.35rem 0.75rem;
  font-size: 0.9rem;
  line-height: 1.25rem;
  max-width: 75%;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  margin: 2px 0;
}
.bubble-me {
  background: #3b82f6;
  color: white;
  border-top-right-radius: 0.4rem;
}
.bubble-other {
  background: #fff;
  color: #1f2937;
  border: 1px solid #e5e7eb;
  border-top-left-radius: 0.4rem;
}

/* ğŸ§© Header Desktop */
.chat-header {
  position: sticky;
  top: 0;
  z-index: 30;
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid #e5e7eb;
  padding: 0.75rem 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.4rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.chat-header img {
  width: 44px;
  height: 44px;
}

/* Overlay video corretto */
#videoOverlay {
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.85);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

#videoOverlay.flex {
  opacity: 1;
  pointer-events: auto;
}

/* --- ğŸ“± MOBILE --- */
@media (max-width: 480px) {

  :root {
    --vvh: 1vh; /* fallback, verrÃ  aggiornato da JS su iOS */
  }

  html, body {
    height: 100%;
    margin: 0;
    background: #fff !important;
  }
  body[data-chat="true"]{
    overflow: hidden; /* lo applichi solo quando sei in chat */
  }

  body {
    position: relative; /* ğŸ”¥ necessario per absolute child */
  }

  #chatContainer{
    position: fixed;
    top: var(--navbar-height);
    left: 0;
    right: 0;

    /* âœ… altezza reale visibile (sopra barra indirizzi iOS) */
    height: calc(100dvh - var(--navbar-height));

    display: flex;
    flex-direction: column;
    background: #fff;
    overflow: hidden;
  }

  /* disattiva card desktop */
  .max-w-3xl.mx-auto {
    all: unset;
    display: flex;
    flex-direction: column;

    /* âœ… piÃ¹ affidabile di height:100% su iOS */
    flex: 1 1 auto;
    min-height: 0;
    width: 100%;
  }

  /* header */
  .chat-header {
    flex: 0 0 auto;
    position: relative !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    z-index: 5;
  }

  /* area messaggi */
  #msgWrap {
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
    -webkit-overflow-scrolling: auto;
    background: #f9fafb;
    padding: 0.5rem 0.7rem;
  }

  /* typing indicator */
  #typingIndicator {
    flex: 0 0 auto;
  }

  /* composer */
  #composer {
    flex: 0 0 auto;
    position: relative; /* ğŸ”¥ NON fixed */
    background: #fff;
    border-top: 1px solid #e5e7eb;
    padding: 0.5rem 0.8rem;
    padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
  }

  /* BLOCCA ZOOM IOS */
  .chat-input {
    font-size: 16px !important;
  }

  .send-btn {
    font-size: 14px;
  }

  body[data-chat="true"] footer {
    display: none !important;
  }

  .chat-header img {
    width: 36px !important;
    height: 36px !important;
    min-width: 36px;
    min-height: 36px;
    object-fit: cover;
    display: block;
  }


  /* iOS FIX: niente blur su elementi in fixed */
  .chat-header,
  .max-w-3xl.mx-auto,
  #chatContainer {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }

  /* lâ€™header aveva anche background semi-trasparente */
  .chat-header {
    background: #fff !important;
  }
}
</style>

<style>
/* âœ… Mostra sempre su desktop */
@media (min-width: 641px) {
  body[data-chat="true"] nav .user-info {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
  }
}

/* âœ… Nascondi solo su mobile */
@media (max-width: 640px) {
  body[data-chat="true"] nav .user-info {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
  }
}
</style>
<style>
  @media (min-width: 481px) {

    /* Il container non deve forzare viewport height */
    #chatContainer {
      position: relative !important;
      height: auto !important;
      min-height: 0 !important;
    }

    .max-w-3xl.mx-auto {
      height: 75vh;              /* finestra chat */
      max-height: 75vh;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      position: sticky;
      top: 0;
      z-index: 30;
    }

    #msgWrap {
      flex: 1;
      overflow-y: auto;
      padding-top: 0;
    }
    /* Layout verticale pagina */
    body[data-chat="true"] {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Lâ€™area contenuto cresce */
    body[data-chat="true"] #chatContainer {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: calc(var(--navbar-height) + 20px);
    }

    /* Finestra chat */
    body[data-chat="true"] .max-w-3xl.mx-auto {
      height: 75vh;
      max-height: 75vh;
      display: flex;
      flex-direction: column;
      margin-top: 0 !important;
    }

    /* Footer in basso, normale */
    body[data-chat="true"] footer {
      margin-top: auto;
    }

  }
</style>



<div id="chatContainer">
<div class="max-w-3xl mx-auto rounded-2xl shadow bg-white/70 backdrop-blur-md overflow-hidden mt-6 border border-gray-100">

  <!-- header -->
<div class="chat-header flex items-center justify-between px-4 py-3 border-b bg-white/80 backdrop-blur">
      <!-- Pulsante torna indietro -->
      <div class="flex items-center gap-2">

        <a id="backBtn" href="#"
           class="chat-back flex items-center gap-1 text-sm text-gray-500 hover:text-blue-600 transition">
          â† <span class="hidden sm:inline">Torna</span>
        </a>

        {% if g.utente['ruolo'] == 'admin' %}
        <form action="{{ url_for('chiudi_chat', other_id=altro['id']) }}"
              method="POST"
              onsubmit="return confirm('Vuoi davvero chiudere definitivamente la chat?');">
            <button class="px-3 py-1.5 bg-red-100 text-red-700 border border-red-300 rounded-lg text-xs hover:bg-red-200">
                âŒ Chiudi
            </button>
        </form>
        {% endif %}

      </div>

    <!-- Info utente -->
    {% if not is_support %}
      <!-- âœ… UTENTE NORMALE: cliccabile -->
      <a id="openProfile" href="{{ url_for('profilo_pubblico', id=altro['id']) }}"
         class="flex items-center gap-3 group hover:bg-gray-50 rounded-lg px-2 py-1 transition"
         title="Vai al profilo pubblico di @{{ altro['username'] }}">
    {% else %}
      <!-- ğŸ›Ÿ SUPPORTO: NON cliccabile (div al posto di <a>) -->
      <div class="flex items-center gap-3 px-2 py-1">
    {% endif %}

        <img src="{{ url_for('static', filename=altro['foto_profilo']) if altro['foto_profilo'] else url_for('static', filename='images/default_user.png') }}"
             alt="Profilo di {{ altro['username'] }}"
             class="w-9 h-9 rounded-full object-cover border border-gray-200 shadow-sm">

        <div class="flex flex-col leading-tight">
          <span class="font-medium text-gray-800">@{{ altro['username'] }}</span>
          <span class="text-xs text-gray-500">in chat con te</span>
        </div>

    {% if not is_support %}
      </a>
    {% else %}

      </div>
    {% endif %}
    <!-- ğŸ¥ Pulsante Video -->
    <button id="videoBtn"
            class="px-3 py-1.5 bg-green-100 text-green-700 border border-green-300 rounded-lg text-xs hover:bg-green-200">
        ğŸ¥ Video
    </button>


  </div>

  <!-- AREA MESSAGGI -->
  <div id="msgWrap"
       class="overflow-y-auto px-6 py-5 bg-gradient-to-b from-gray-50 to-gray-100 space-y-1 rounded-b-2xl">
       {% set last_written_day = None %}
       {% for m in conversazione %}
         {% set is_me = (m['mittente_id'] == g.utente['id']) %}
         <div class="flex {% if is_me %}justify-end{% else %}justify-start{% endif %}">
           <div data-mid="{{ m['id'] }}" data-created-at="{{ m['created_at'] }}"
                class="bubble {% if is_me %}bubble-me{% else %}bubble-other{% endif %}">
             <div class="whitespace-pre-wrap break-words">{{ m['testo'] }}</div>
             <div class="flex items-center justify-end gap-1 mt-0.5 text-[10px] opacity-70 text-right">
               {% set dt = m['created_at'] | replace("T", " ") | to_datetime %}
               <span>
                 {% if dt %}{{ dt.astimezone(pytz.timezone("Europe/Rome")).strftime("%H:%M") }}{% endif %}
               </span>
               {% if is_me %}
                 {% if m['letto'] %}
                   <span class="text-blue-400">âœ…âœ…</span>
                 {% elif m['consegnato'] %}
                   <span class="text-gray-400">âœ…</span>
                 {% else %}
                   <span class="text-gray-400">â³</span>
                 {% endif %}
               {% endif %}
             </div>
           </div>
         </div>
       {% endfor %}
      </div>
  <!-- indicatore sta scrivendo -->
  <div id="typingIndicator" class="px-4 py-2 text-center typing-indicator hidden">
    Sta scrivendoâ€¦
  </div>

  <!-- composer -->
  <form id="composer" action="javascript:void(0)" class="flex items-center gap-2 p-3 border-t bg-white" autocomplete="off">
    <input type="hidden" id="destinatario_id" value="{{ altro['id'] }}">

    <!-- input + emoji -->
    <div class="relative flex-1">
      <input id="msgInput" type="text" name="testo"
             class="chat-input w-full pr-10"
             placeholder="Scrivi un messaggioâ€¦" required>

      <button type="button" id="emojiBtn"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 emoji-btn text-lg"
              aria-label="Apri emoji">ğŸ˜Š</button>

      <!-- emoji popover -->
      <div id="emojiPopover"
           class="hidden absolute bottom-[110%] right-0 w-64 max-h-56 overflow-y-auto rounded-xl border bg-white shadow-lg p-2">
        <div class="grid grid-cols-8 gap-1 text-lg leading-none select-none">
          {% for e in ['ğŸ˜€','ğŸ˜','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜','ğŸ˜˜','ğŸ˜','ğŸ¤—','ğŸ¤”','ğŸ˜…','ğŸ™ƒ','ğŸ™‚','ğŸ˜‡','ğŸ¥³','ğŸ¤©',
                       'ğŸ‘','ğŸ‘','ğŸ™','ğŸ‘','ğŸ’ª','ğŸ”¥','âœ¨','ğŸ‰','â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ¤','ğŸ¤'] %}
            <button type="button" class="emoji-btn p-1 hover:bg-gray-100 rounded">{{ e }}</button>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- pulsante invia -->
    <button id="sendBtn" type="submit"
            class="send-btn rounded-xl bg-blue-600 text-white px-5 py-2 text-sm font-medium shadow-sm hover:shadow-md">
      Invia
    </button>
  </form>
</div>

<script>
  window.chatAperta = true;
  window.addEventListener('beforeunload', () => { window.chatAperta = false; });
</script>
<script>
function whenSocketReady(callback) {
  if (window.socket) {
    callback(window.socket);
  } else {
    window.addEventListener("socket_ready", () => {
      callback(window.socket);
    }, { once: true });
  }
}
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    whenSocketReady((socket) => {

      const meId = parseInt("{{ g.utente['id'] }}", 10);
    const wrap = document.getElementById('msgWrap');
    const input = document.getElementById('msgInput');
    const form = document.getElementById('composer');
    const typingIndicator = document.getElementById('typingIndicator');

    const destId = parseInt(document.getElementById('destinatario_id').value, 10);

    console.log("ğŸŸ¢ Chat collegata al socket globale", { meId, destId, connected: socket.connected });

    function initSocketEvents() {
      console.log("ğŸŸ¢ Socket pronto â†’ join stanza");
      socket.emit('join', { user_id: meId });

      // ğŸ“¡ Notifica apertura (UNA SOLA VOLTA)
      socket.emit('chat_aperta', { other_id: destId });
      socket.emit('mark_as_read', { other_id: destId });
    }

    if (socket.connected) initSocketEvents();
    else socket.once('connect', initSocketEvents);

    window.addEventListener('beforeunload', () => socket.emit('chat_chiusa', { other_id: destId }));

  // ğŸ­ Emoji
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPopover = document.getElementById('emojiPopover');
  function toggleEmoji(open) {
    const willOpen = typeof open === 'boolean' ? open : emojiPopover.classList.contains('hidden');
    emojiPopover.classList.toggle('hidden', !willOpen);
  }
  function insertAtCursor(el, text) {
    const start = el.selectionStart ?? el.value.length;
    const end = el.selectionEnd ?? el.value.length;
    el.value = el.value.slice(0, start) + text + el.value.slice(end);
    const pos = start + text.length;
    el.setSelectionRange(pos, pos); el.focus();
  }
  emojiBtn.addEventListener('click', e => { e.preventDefault(); toggleEmoji(true); });
  emojiPopover.addEventListener('click', e => {
    const btn = e.target.closest('.emoji-btn'); if (!btn) return;
    insertAtCursor(input, btn.textContent); toggleEmoji(false);
  });
  document.addEventListener('click', e => {
    if (!emojiPopover.contains(e.target) && e.target !== emojiBtn) toggleEmoji(false);
  });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') toggleEmoji(false); });

  // ğŸ”§ Utility
  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, tag => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[tag]));
  }
  function formatOra(datetimeStr) {
      if (!datetimeStr) return '';

      // Normalizza eventuale spazio â†’ ISO valido
      const clean = datetimeStr.replace(' ', 'T');

      // LASCIA decidere al browser il fuso corretto
      const d = new Date(clean);

      if (isNaN(d)) return datetimeStr.slice(11, 16);

      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');

      return `${hh}:${mm}`;
  }

  // ğŸ§± Genera bolla messaggio
  function bubble({ id, mittente_id, testo, created_at, consegnato, letto, me_id }) {
    const isMe = mittente_id === me_id;
    const outer = document.createElement('div');
    outer.className = 'msg-line flex ' + (isMe ? 'justify-end' : 'justify-start');
    const inner = document.createElement('div');
    inner.className = 'bubble ' + (isMe ? 'bubble-me' : 'bubble-other');
    inner.setAttribute('data-mid', id);
    inner.setAttribute('data-created-at', created_at);
    const spunte = isMe
      ? `<span class="spunte">${
          letto
            ? '<span class="text-blue-400">âœ…âœ…</span>'
            : consegnato
              ? '<span class="text-gray-400">âœ…</span>'
              : '<span class="text-gray-400">â³</span>'
        }</span>` : '';
    inner.innerHTML = `
      <div class="whitespace-pre-wrap break-words">${escapeHTML(testo)}</div>
      <div class="flex items-center justify-end gap-1 mt-0.5 text-[10px] opacity-70 text-right">
        <span>${formatOra(created_at)}</span>${spunte}
      </div>`;
    outer.appendChild(inner);
    return outer;
  }

  // ğŸ§­ Scroll
  function isAtBottom() {
    const threshold = 60;
    return wrap.scrollHeight - wrap.scrollTop - wrap.clientHeight < threshold;
  }
  function scrollBottom(smooth = false) {
    requestAnimationFrame(() => {
      wrap.scrollTo({ top: wrap.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
    });
  }

  // âœï¸ Indicatore "sta scrivendo"
  let typingTimeout = null;
  let wasTyping = false;

  input.addEventListener("input", () => {
    // invia typing:true solo la prima volta
    if (!wasTyping) {
      wasTyping = true;
      socket.emit("typing", { to: destId, typing: true });
    }

    // reset timeout
    clearTimeout(typingTimeout);

    typingTimeout = setTimeout(() => {
      wasTyping = false;
      socket.emit("typing", { to: destId, typing: false });
    }, 2000); // puoi abbassare a 1000ms se vuoi piÃ¹ reattivitÃ 
  });

  socket.on('user_typing', data => {
    if (data.from !== destId) return;
    if (data.typing) {
      typingIndicator.classList.remove('hidden');
      clearTimeout(typingIndicator._hide);
      typingIndicator._hide = setTimeout(() => typingIndicator.classList.add('hidden'), 2000);
    } else typingIndicator.classList.add('hidden');
  });

  // ğŸ—“ï¸ Gestione intestazioni data (solo sopra il primo messaggio di ogni giorno)
  function formatDateIT(datetimeStr) {
    if (!datetimeStr) return '';
    try {
      const clean = datetimeStr.trim().replace('T', ' ').replace('Z', '').replace(/\//g, '-');
      const [y, m, d] = clean.split(' ')[0].split('-').map(Number);
      const dt = new Date(y, m - 1, d);
      const oggi = new Date();
      if (
        dt.getDate() === oggi.getDate() &&
        dt.getMonth() === oggi.getMonth() &&
        dt.getFullYear() === oggi.getFullYear()
      ) return 'Oggi';
      return dt.toLocaleDateString('it-IT', { day: '2-digit', month: 'long', year: 'numeric' });
    } catch { return ''; }
  }

  function ensureDateHeaderFor(datetimeStr) {
    if (!datetimeStr) return;
    const day = datetimeStr.split(/[ T]/)[0];

    // evita duplicati
    if (document.querySelector(`#msgWrap .date-header[data-day="${day}"]`)) return;

    // trova il primo messaggio del giorno
    const msgs = [...document.querySelectorAll('#msgWrap [data-created-at]')];
    const firstOfDay = msgs.find(msg => (msg.getAttribute('data-created-at') || '').startsWith(day));

    // crea intestazione
    const div = document.createElement('div');
    div.className = 'text-center text-xs text-gray-400 my-2 date-header';
    div.setAttribute('data-day', day);
    div.textContent = formatDateIT(datetimeStr);

    // inserisci sopra il primo messaggio del giorno
    if (firstOfDay && firstOfDay.parentNode) {
      firstOfDay.parentNode.parentNode.insertBefore(div, firstOfDay.parentNode);
    } else {
      document.getElementById('msgWrap').appendChild(div);
    }
  }

  function cleanDuplicateDates() {
    const seen = new Set();
    document.querySelectorAll('#msgWrap .date-header').forEach(el => {
      const day = el.getAttribute('data-day');
      if (seen.has(day)) el.remove(); else seen.add(day);
    });
  }

  function aggiornaIntestazioniDate() {
    const msgs = document.querySelectorAll('#msgWrap [data-created-at]');
    let lastDay = null;
    msgs.forEach(msg => {
      const raw = msg.getAttribute('data-created-at');
      if (!raw) return;
      const day = raw.split(/[ T]/)[0];
      if (day !== lastDay) {
        ensureDateHeaderFor(raw);
        lastDay = day;
      }
    });
    cleanDuplicateDates();
  }
  // ğŸ§¹ Allâ€™avvio
  aggiornaIntestazioniDate();

  // doppio frame per assicurare layout stabile
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      scrollBottom(false);
    });
  });
  // ğŸ’¬ Ricezione messaggi (versione blindata)
  socket.on('new_message', (m) => {

    try {

      const sameChat =
        (m.mittente_id === meId && m.destinatario_id === destId) ||
        (m.destinatario_id === meId && m.mittente_id === destId);

      if (!sameChat) return;

      const alreadyBottom = isAtBottom();

      if (m.created_at) {
        ensureDateHeaderFor(m.created_at);
      }

      const bolla = bubble({ ...m, me_id: meId });
      wrap.appendChild(bolla);

      cleanDuplicateDates();

      if (alreadyBottom) {
        setTimeout(() => scrollBottom(true), 80);
      }

      // â­ aggiorna spunte solo se Ã¨ mio
      if (m.mittente_id === meId) {
        const spunte = bolla.querySelector('.spunte');
        if (spunte) {
          if (m.letto) {
            spunte.innerHTML = '<span class="text-blue-400">âœ…âœ…</span>';
          } else if (m.consegnato) {
            spunte.innerHTML = '<span class="text-gray-400">âœ”</span>';
          } else {
            spunte.innerHTML = '<span class="text-gray-400">â³</span>';
          }
        }
      }

      // Se ricevo â†’ segno come letto
      if (m.destinatario_id === meId) {
        socket.emit('mark_as_read', { other_id: m.mittente_id });
      }

    } catch (err) {

      console.error("ğŸ”¥ Errore in new_message:", err, m);

    }

  });

  // ğŸ”µ Aggiornamento spunte
  socket.on('messages_read', data => {
    if (data.from !== destId) return;

    // aggiorna SOLO i messaggi inviati da me e NON aggiornati
    document.querySelectorAll('.bubble-me .spunte').forEach(spunte => {
      spunte.innerHTML = '<span class="text-blue-400">âœ…âœ…</span>';
    });
  });


  // ğŸ“¨ Invio messaggio
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const testo = input.value.trim();
    if (!testo) return;
    socket.emit('send_message', { destinatario_id: destId, testo });
    input.value = '';
    toggleEmoji(false);
    });
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const back = document.getElementById("backBtn");
  if (!back) return;

  back.addEventListener("click", (e) => {
    e.preventDefault();

    // 1ï¸âƒ£ Segnala la chiusura della chat
    try {
      const destId = parseInt(document.getElementById("destinatario_id")?.value || "0", 10);
      if (window.socket && destId) window.socket.emit("chat_chiusa", { other_id: destId });
    } catch (_) {}

    // 2ï¸âƒ£ Torna alla pagina precedente se esiste
    if (document.referrer && document.referrer !== window.location.href) {
      window.history.back();
      return;
    }

    // 3ï¸âƒ£ Fallback: torna alla lista chat
    window.location.href = "{{ url_for('chat_threads_view') }}";
  });
});
</script>
  <script>
document.addEventListener("DOMContentLoaded", () => {
  const link = document.getElementById("openProfile");
  const destIdEl = document.getElementById("destinatario_id");
  if (!link || !destIdEl) return;

  link.addEventListener("click", () => {
    const destId = parseInt(destIdEl.value || "0", 10);
    try {
      if (window.socket && destId) window.socket.emit("chat_chiusa", { other_id: destId });
    } catch(_) {}
  });
});
</script>
<script src="https://unpkg.com/@daily-co/daily-js"></script>

<script>
async function initVideoSystem() {
    console.log("ğŸ¥ Video system init");
    if (window.__videoSystemInited) {
        console.log("ğŸ¥ Video system giÃ  inizializzato, skip.");
        return;
      }
      window.__videoSystemInited = true;

    // ==============================
    // SOCKET
    // ==============================
    const socket = window.socket;
    if (!socket) {
        console.error("âŒ Socket non disponibile");
        return;
    }

    const meId = parseInt("{{ g.utente['id'] }}", 10);

    // ==============================
    // ELEMENTI
    // ==============================
    const videoBtn   = document.getElementById("videoBtn");
    const overlay    = document.getElementById("videoOverlay");
    const container  = document.getElementById("videoContainer");
    const closeBtn   = document.getElementById("closeVideo");
    const destIdEl   = document.getElementById("destinatario_id");
    const mount = document.getElementById("videoMount");

    if (!videoBtn || !overlay || !container || !mount || !closeBtn || !destIdEl) {
        console.error("âŒ Elementi video mancanti");
        return;
    }

    const destId = parseInt(destIdEl.value, 10);

    let currentRoomName = null

    // ğŸ‘‡ METTI QUI LA FUNZIONE
    async function attemptVideoStart() {

        const res = await fetch("/video/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ altro_utente_id: destId })
        });

        const data = await res.json();

        if (data.need_verifica) {
            showMaggiorenneModal();
            return false;
        }

        if (!res.ok || data.error) {
            alert(data.error || "Errore video");
            return false;
        }

        await startCall(data.room_name, data.room_url);
        return true;
    }

    const maggiorenneModal = document.getElementById("maggiorenneModal");
    const maggiorenneCheck = document.getElementById("maggiorenneCheck");
    const maggiorenneConfirm = document.getElementById("maggiorenneConfirm");
    const maggiorenneCancel = document.getElementById("maggiorenneCancel");

    function showMaggiorenneModal() {
        maggiorenneCheck.checked = false;
        maggiorenneModal.classList.remove("hidden");
        maggiorenneModal.classList.add("flex");
    }

    function hideMaggiorenneModal() {
        maggiorenneModal.classList.add("hidden");
        maggiorenneModal.classList.remove("flex");
    }

    maggiorenneCancel.onclick = () => {
        hideMaggiorenneModal();
    };

    maggiorenneConfirm.onclick = async () => {

        if (!maggiorenneCheck.checked) {
            alert("Devi confermare di essere maggiorenne.");
            return;
        }

        try {
            await fetch("/video/verifica-maggiorenne", {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            });

            hideMaggiorenneModal();

            // ğŸ” riprova ad avviare la call
            await attemptVideoStart();

        } catch (err) {
            console.error("Errore verifica maggiorenne", err);
            alert("Errore verifica.");
        }
    };

    let callObject = null;
    let pingInterval = null;


    // ==============================
    // EVENTI SOCKET
    // ==============================
    socket.off("video_call_rejected");
    socket.off("video_call_left");

    socket.on("video_call_rejected", async (data) => {
        if (!currentRoomName) return;
        if (data.room === currentRoomName) {
            alert("L'utente ha rifiutato la chiamata.");
            await endCall();
        }
    });

    socket.on("video_call_left", async (data) => {
        if (!currentRoomName) return;
        if (data.room === currentRoomName) {
            await endCall();
        }
    });

    // ==============================
    // CLICK VIDEO
    // ==============================
    videoBtn.onclick = null;   // reset handler vecchio
    videoBtn.onclick = async function () {

        if (videoBtn.disabled) return;

        videoBtn.disabled = true;
        videoBtn.innerText = "â³ Controllo...";

        try {
            const started = await attemptVideoStart();

            // reset solo se la call NON parte
            if (!started) {
                resetBtn();
            }

        } catch (err) {
            console.error("Errore avvio video:", err);
            alert("Errore connessione video");
            resetBtn();
        }
    });

    function resetBtn() {
        videoBtn.disabled = false;
        videoBtn.innerText = "ğŸ¥ Video";
    }

    // ==============================
    // START CALL
    // ==============================
    async function startCall(roomName, roomUrl) {

        console.log("ğŸ“ Start call:", roomName);

        currentRoomName = roomName;

        if (pingInterval) clearInterval(pingInterval);

        pingInterval = setInterval(() => {
            if (!currentRoomName) return;
            fetch("/video/ping", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ room_name: currentRoomName })
            }).catch(() => {});
        }, 10000);

        overlay.classList.remove("hidden");
        overlay.classList.add("flex");
        mount.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full text-white">
                <h2 class="text-xl mb-6">Videochiamata pronta</h2>
                <div class="flex gap-4">
                    <button id="enterCall"
                        class="bg-green-600 px-5 py-2 rounded-lg">
                        Entra
                    </button>
                    <button id="cancelCall"
                        class="bg-gray-600 px-5 py-2 rounded-lg">
                        Annulla
                    </button>
                </div>
            </div>
        `;

        document.getElementById("cancelCall").onclick = async () => {
            socket.emit("video_call_rejected", { room: currentRoomName });
            await endCall();
        };


        document.getElementById("enterCall").onclick = async () => {

            mount.innerHTML = "";

            const check = await fetch("/video/check-maggiorenne");
            const checkData = await check.json();

            if (!checkData.verified) {
                showMaggiorenneModal();
                return;
            }

            callObject = Daily.createFrame(mount, {
                showLeaveButton: true,
                iframeStyle: {
                    width: "100%",
                    height: "100%",
                    border: "0"
                }
            });

            callObject.on("left-meeting", () => {
                socket.emit("video_call_left", { room: currentRoomName });
                endCall();
            });

            callObject.on("error", (e) => {
                console.error("Daily error:", e);
                socket.emit("video_call_left", { room: currentRoomName });
                endCall();
            });

            await callObject.join({
                url: roomUrl,
                audioSource: true,
                videoSource: true
            });

        };
    }
    // âœ… Disponibile SEMPRE per base.html
    window.startIncomingCall = async function(roomName, roomUrl) {
        await startCall(roomName, roomUrl);
    };

    // ğŸ”¥ INCOMING REDIRECT (ORA Ãˆ SICURO)
    const params = new URLSearchParams(window.location.search);
    if (params.get("incoming") === "1") {
      const roomName = params.get("room");
      const roomUrl  = params.get("url");

      if (roomName && roomUrl) {
        console.log("ğŸ“ Incoming redirect â†’ avvio quando socket Ã¨ pronto");

        const startWhenReady = () => {
          if (socket && socket.connected) {
            startCall(roomName, roomUrl);
          } else {
            socket.once("connect", () => startCall(roomName, roomUrl));
          }
        };

        startWhenReady();
        history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // ==============================
    // CHIUSURA
    // ==============================
    closeBtn.addEventListener("click", async () => {
        if (callObject) await callObject.leave();
        endCall();
    });

    async function endCall() {

        // ğŸ›¡ï¸ Evita doppia esecuzione
        if (!currentRoomName) return;

        overlay.classList.add("hidden");
        overlay.classList.remove("flex");

        if (pingInterval) {
            clearInterval(pingInterval);
            pingInterval = null;
        }

        if (callObject) {
            callObject.destroy();
            callObject = null;
        }

        try {
            const res = await fetch("/video/end", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ room_name: currentRoomName })
            });

            const data = await res.json();
            console.log("ğŸ§¹ /video/end risposta:", data);

        } catch (err) {
            console.error("âŒ Errore /video/end:", err);
        }

        currentRoomName = null;

        // ğŸ”„ Reset bottone video
        resetBtn();
    }
  } // fine

  // ğŸ”¥ Avvio immediato sicuro
  whenSocketReady(() => {
      initVideoSystem();
  });
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {

    whenSocketReady((socket) => {

        const videoBtn = document.getElementById("videoBtn");
        if (!videoBtn) return;

        const destId = parseInt(document.getElementById("destinatario_id").value);

        // =========================
        // ğŸ” CHECK STATUS ALLâ€™APERTURA
        // =========================
        socket.emit("check_video_status", { user_id: destId });

        socket.off("video_status_result");
        socket.on("video_status_result", (data) => {
            if (data.busy) {
                videoBtn.disabled = true;
                videoBtn.innerText = "ğŸ”´ In chiamata";
                videoBtn.classList.remove("bg-green-100","text-green-700");
                videoBtn.classList.add("bg-gray-200","text-gray-500");
            }
        });

        // =========================
        // ğŸ”´ REALTIME BUSY UPDATE
        // =========================
        socket.off("video_busy");
        socket.on("video_busy", (data) => {

            if (!data) return;

            if (data.user_id === destId) {

                if (data.busy) {
                    videoBtn.disabled = true;
                    videoBtn.innerText = "ğŸ”´ In chiamata";
                    videoBtn.classList.remove("bg-green-100","text-green-700");
                    videoBtn.classList.add("bg-gray-200","text-gray-500");
                } else {
                    videoBtn.disabled = false;
                    videoBtn.innerText = "ğŸ¥ Video";
                    videoBtn.classList.add("bg-green-100","text-green-700");
                    videoBtn.classList.remove("bg-gray-200","text-gray-500");
                }

            }
        });

    }); // fine whenSocketReady

});
</script>
</div>
{% endblock %}
