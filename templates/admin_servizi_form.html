{% extends "layout_admin.html" %}
{% set body_class = "offset-navbar" %}

{% block admin_content %}
<div class="max-w-3xl mx-auto">

  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">
          {% if servizio %}‚úèÔ∏è Modifica servizio{% else %}‚ûï Nuovo servizio{% endif %}
        </h1>
        <p class="text-slate-600 mt-1">
          Solo configurazione admin. Nessuna logica pubblica o pagamenti in questo step.
        </p>
      </div>

      <a href="{{ url_for('admin_servizi') }}"
         class="px-4 py-2 rounded-xl bg-slate-100 text-slate-700 hover:bg-slate-200">
        ‚Üê Indietro
      </a>
    </div>

    <!-- ================= FORM PRINCIPALE ================= -->
    <form method="POST" class="mt-6 space-y-4">

      <!-- CODICE -->
      <div>
        <label class="text-sm font-semibold text-slate-700">Codice servizio (unico)</label>

        <select name="codice"
                class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white"
                {% if servizio %}disabled{% endif %}
                required>

          {% set current = servizio.codice if servizio else '' %}

          <option value="">‚Äî seleziona codice ‚Äî</option>

          <optgroup label="Annunci / Visibilit√†">
            <option value="boost_lista" {% if current=='boost_lista' %}selected{% endif %}>
              boost_lista ‚Äî Boost lista annunci
            </option>
            <option value="vetrina_annuncio" {% if current=='vetrina_annuncio' %}selected{% endif %}>
              vetrina_annuncio ‚Äî Annuncio in vetrina
            </option>
            <option value="badge_evidenza" {% if current=='badge_evidenza' %}selected{% endif %}>
              badge_evidenza ‚Äî Evidenza annuncio (badge + cornice)
            </option>
          </optgroup>

          <optgroup label="Urgenza / Notifiche">
            <option value="annuncio_urgente" {% if current=='annuncio_urgente' %}selected{% endif %}>
              annuncio_urgente ‚Äî Annuncio urgente + notifiche
            </option>
          </optgroup>

          <optgroup label="Contatti">
            <option value="contatti" {% if current=='contatti' %}selected{% endif %}>
              contatti ‚Äî Mostra contatti (profilo + annunci)
            </option>
          </optgroup>

          <optgroup label="Chat / Azioni">
            <option value="chat_extra" {% if current=='chat_extra' %}selected{% endif %}>
              chat_extra ‚Äî Avvia pi√π chat
            </option>
          </optgroup>

          <optgroup label="Profilo / Fiducia">
            <option value="badge_affidabilita" {% if current=='badge_affidabilita' %}selected{% endif %}>
              badge_affidabilita ‚Äî Badge affidabilit√† profilo
            </option>
          </optgroup>

        </select>

        {% if servizio %}
          <!-- codice inviato anche se select disabilitata -->
          <input type="hidden" name="codice" value="{{ servizio.codice }}">
        {% endif %}

        <p class="text-xs text-slate-500 mt-1">
          Codice tecnico interno, non visibile agli utenti.
        </p>
      </div>

      <!-- NOME -->
      <div>
        <label class="text-sm font-semibold text-slate-700">Nome</label>
        <input name="nome"
               required
               value="{{ servizio.nome if servizio else '' }}"
               class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-200">
      </div>

      <!-- DESCRIZIONE -->
      <div>
        <label class="text-sm font-semibold text-slate-700">Descrizione (opzionale)</label>
        <textarea name="descrizione"
                  rows="3"
                  class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-200">{{ servizio.descrizione if servizio and servizio.descrizione else '' }}</textarea>
      </div>

      <!-- AMBITO / TARGET -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-semibold text-slate-700">Ambito</label>
          <select name="ambito" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white">
            {% set val = servizio.ambito if servizio else '' %}
            <option value="annuncio" {% if val=='annuncio' %}selected{% endif %}>annuncio</option>
            <option value="profilo" {% if val=='profilo' %}selected{% endif %}>profilo</option>
            <option value="chat" {% if val=='chat' %}selected{% endif %}>chat</option>
            <option value="homepage" {% if val=='homepage' %}selected{% endif %}>homepage</option>
          </select>
        </div>

        <div>
          <label class="text-sm font-semibold text-slate-700">Target</label>
          <select name="target" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white">
            {% set t = servizio.target if servizio else '' %}
            <option value="offre" {% if t=='offre' %}selected{% endif %}>offre</option>
            <option value="cerca" {% if t=='cerca' %}selected{% endif %}>cerca</option>
            <option value="entrambi" {% if t=='entrambi' %}selected{% endif %}>entrambi</option>
          </select>
        </div>
      </div>

      <!-- DURATA -->
      <div>
        <label class="text-sm font-semibold text-slate-700">Durata default (giorni)</label>
        <input name="durata_default_giorni"
               value="{{ servizio.durata_default_giorni if servizio and servizio.durata_default_giorni else '' }}"
               class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300">
        <p class="text-xs text-slate-500 mt-1">Vuoto = one-shot</p>
      </div>

      <!-- FLAG -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <label class="flex items-center gap-2 p-3 rounded-xl border">
          <input type="checkbox" name="ripetibile" value="1" {% if servizio is none or servizio.ripetibile %}checked{% endif %}>
          Ripetibile
        </label>

        <label class="flex items-center gap-2 p-3 rounded-xl border">
          <input type="checkbox" name="attivabile_admin" value="1" {% if servizio is none or servizio.attivabile_admin %}checked{% endif %}>
          Attivabile da admin
        </label>

        <label class="flex items-center gap-2 p-3 rounded-xl border">
          <input type="checkbox" name="attivo" value="1" {% if servizio is none or servizio.attivo %}checked{% endif %}>
          Servizio attivo
        </label>
      </div>

      <!-- AZIONI -->
      <div class="pt-4 flex gap-2">
        <button type="submit"
                class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">
          {% if servizio %}Salva modifiche{% else %}Crea servizio{% endif %}
        </button>

        <a href="{{ url_for('admin_servizi') }}"
           class="px-4 py-2 rounded-xl bg-slate-100 text-slate-700 hover:bg-slate-200">
          Annulla
        </a>
      </div>
    </form>

    {% if servizio %}
      <div class="mt-8 pt-6 border-t border-slate-200">
        <h2 class="text-lg font-semibold text-slate-800 mb-2">
          üí∞ Piani e prezzi
        </h2>

        <p class="text-sm text-slate-600 mb-4">
          Configura le durate e i prezzi acquistabili dagli utenti per questo servizio.
        </p>

        <a href="{{ url_for('admin_servizi_piani', servizio_id=servizio.id) }}"
           class="inline-flex items-center gap-2 px-4 py-2 rounded-xl
                  bg-emerald-600 text-white hover:bg-emerald-700">
          üì¶ Gestisci piani del servizio
        </a>
      </div>
    {% endif %}

    <!-- ================= ELIMINA (FORM SEPARATO) ================= -->
    {% if servizio %}
      <div class="mt-8 pt-6 border-t border-slate-200">
        <form method="POST"
              action="{{ url_for('admin_servizi_elimina', servizio_id=servizio.id) }}"
              onsubmit="return confirm(
                '‚ö†Ô∏è Sei sicuro di voler DISATTIVARE questo servizio?\n\n' +
                'Non sar√† pi√π vendibile ma rester√† nello storico.'
              )">

          <button type="submit"
                  class="px-4 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700">
            üóëÔ∏è Disattiva servizio
          </button>
        </form>
      </div>
    {% endif %}

  </div>
</div>
{% endblock %}
